<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manheim Analyzer Pro | Multi-Source Retail Valuation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    .gradient-bg { background: radial-gradient(ellipse at top left, rgba(6, 182, 212, 0.15) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.1) 0%, transparent 50%); }
    .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
    .tab-active { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: slideIn 0.3s ease-out forwards; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1e293b; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    input[type="file"] { display: none; }
    .rank-badge { min-width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 12px; }
    .hot-gradient { background: linear-gradient(135deg, #f97316, #ef4444); }
    .cool-gradient { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
    .source-pill { font-size: 10px; padding: 2px 8px; border-radius: 9999px; font-weight: 600; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-white gradient-bg">
  <header class="border-b border-slate-800/50 glass sticky top-0 z-40">
    <div class="max-w-[1800px] mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 via-blue-500 to-emerald-500 flex items-center justify-center shadow-lg shadow-cyan-500/20">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path></svg>
          </div>
          <div>
            <h1 class="text-2xl font-black tracking-tight bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Manheim Analyzer Pro</h1>
            <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 pulse-dot"></span><p class="text-slate-500 text-sm">Multi-Source Retail Valuation ‚Ä¢ Jan 2026</p></div>
          </div>
        </div>
        <div class="hidden lg:flex items-center gap-6">
          <div class="text-right"><p class="text-slate-500 text-xs uppercase tracking-wider">MUVVI Index</p><p class="text-xl font-bold text-white">206.0 <span class="text-emerald-400 text-sm">+0.6%</span></p></div>
          <div class="w-px h-10 bg-slate-700"></div>
          <div class="text-right"><p class="text-slate-500 text-xs uppercase tracking-wider">Avg Retail</p><p class="text-xl font-bold text-cyan-400">$25,730</p></div>
          <div class="w-px h-10 bg-slate-700"></div>
          <div class="text-right"><p class="text-slate-500 text-xs uppercase tracking-wider">Your Vehicles</p><p class="text-xl font-bold text-white" id="headerVehicleCount">0</p></div>
        </div>
        <div class="flex items-center gap-3">
          <label class="px-4 py-2 border border-slate-600 rounded-xl text-slate-300 hover:bg-slate-800 transition-colors cursor-pointer flex items-center gap-2">Import<input type="file" id="csvImport" accept=".csv" onchange="importCSV(event)"></label>
          <button onclick="exportAllData()" class="px-4 py-2 border border-slate-600 rounded-xl text-slate-300 hover:bg-slate-800 transition-colors">Export</button>
          <button onclick="showAnalyzeForm()" class="px-5 py-2.5 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-semibold hover:from-cyan-400 hover:to-blue-500 transition-all shadow-lg shadow-cyan-500/20 flex items-center gap-2">üîç Analyze Vehicle</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-[1800px] mx-auto px-6 py-6">
    <div class="flex items-center gap-2 mb-6 overflow-x-auto pb-2">
      <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 tab-active text-white">üìä Dashboard</button>
      <button onclick="switchTab('market')" id="tab-market" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-800/50 text-slate-400 hover:bg-slate-700/50">üî• Market Intel</button>
      <button onclick="switchTab('watchlist')" id="tab-watchlist" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-800/50 text-slate-400 hover:bg-slate-700/50">üëÅÔ∏è Watchlist <span class="bg-cyan-500/20 text-cyan-400 text-xs px-2 py-0.5 rounded-full" id="watchlistCount">0</span></button>
      <button onclick="switchTab('inventory')" id="tab-inventory" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-800/50 text-slate-400 hover:bg-slate-700/50">üì¶ Inventory <span class="bg-emerald-500/20 text-emerald-400 text-xs px-2 py-0.5 rounded-full" id="inventoryCount">0</span></button>
      <button onclick="switchTab('history')" id="tab-history" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-800/50 text-slate-400 hover:bg-slate-700/50">üìú History <span class="bg-slate-500/20 text-slate-400 text-xs px-2 py-0.5 rounded-full" id="historyCount">0</span></button>
      <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-5 py-2.5 rounded-xl font-medium transition-all flex items-center gap-2 bg-slate-800/50 text-slate-400 hover:bg-slate-700/50">‚öôÔ∏è Settings</button>
    </div>
    <div id="tabContent"><div id="content-dashboard"></div><div id="content-market" class="hidden"></div><div id="content-watchlist" class="hidden"></div><div id="content-inventory" class="hidden"></div><div id="content-history" class="hidden"></div><div id="content-settings" class="hidden"></div></div>
  </main>

  <div id="analyzeModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
    <div class="glass border border-slate-700 rounded-3xl p-8 max-w-5xl w-full max-h-[95vh] overflow-y-auto scrollbar-thin">
      <div class="flex items-center justify-between mb-6">
        <div><h2 class="text-2xl font-bold text-white">üîç Analyze Vehicle</h2><p class="text-slate-400 text-sm mt-1">Enter <strong>Adjusted MMR</strong> from mmr.manheim.com for comprehensive retail valuation</p></div>
        <button onclick="hideAnalyzeModal()" class="text-slate-400 hover:text-white transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      <form id="analyzeForm" onsubmit="runAnalysis(event)">
        <input type="hidden" id="a_vehicleId">
        <div class="mb-6 p-5 bg-slate-900/50 rounded-2xl border border-slate-700/50">
          <h3 class="text-sm font-semibold text-cyan-400 uppercase tracking-wider mb-4">üìã Vehicle Information</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-slate-400 text-sm">Year *</label><input type="number" id="a_year" value="2022" min="2000" max="2026" required class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Make *</label><input type="text" id="a_make" placeholder="Toyota" required list="makesList" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"><datalist id="makesList"><option value="Toyota"><option value="Honda"><option value="Ford"><option value="Chevrolet"><option value="Nissan"><option value="Hyundai"><option value="Kia"><option value="Subaru"><option value="Mazda"><option value="BMW"><option value="Mercedes-Benz"><option value="Lexus"><option value="Audi"><option value="Tesla"><option value="Jeep"><option value="Ram"><option value="GMC"><option value="Volkswagen"><option value="Volvo"><option value="Acura"><option value="Infiniti"><option value="Cadillac"><option value="Lincoln"><option value="Buick"><option value="Chrysler"><option value="Dodge"><option value="Porsche"><option value="Land Rover"><option value="Jaguar"><option value="Genesis"><option value="Rivian"></datalist></div>
            <div><label class="text-slate-400 text-sm">Model *</label><input type="text" id="a_model" placeholder="Camry" required class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Trim</label><input type="text" id="a_trim" placeholder="SE, XLE..." class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
            <div><label class="text-slate-400 text-sm">VIN</label><input type="text" id="a_vin" placeholder="1HGBH41JXMN109186" maxlength="17" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 mono text-sm focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Mileage *</label><input type="number" id="a_mileage" value="50000" required class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Segment</label><select id="a_segment" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"><option value="luxury">Luxury</option><option value="ev">Electric Vehicle</option><option value="hybrid">Hybrid</option><option value="suv" selected>SUV</option><option value="crossover">Crossover</option><option value="pickup">Pickup Truck</option><option value="midsize_car">Midsize Car</option><option value="compact_car">Compact Car</option><option value="sports">Sports Car</option><option value="minivan">Minivan</option></select></div>
            <div><label class="text-slate-400 text-sm">Condition Grade (1-5)</label><input type="number" id="a_grade" value="3.5" min="1" max="5" step="0.1" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div><label class="text-slate-400 text-sm">Color</label><select id="a_color" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"><option value="white">White</option><option value="black">Black</option><option value="silver">Silver/Gray</option><option value="blue">Blue</option><option value="red">Red</option><option value="other">Other</option></select></div>
            <div><label class="text-slate-400 text-sm">Auction Location</label><input type="text" id="a_location" placeholder="Manheim Seattle" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
          </div>
        </div>
        <div class="mb-6 p-5 bg-gradient-to-br from-cyan-500/10 to-blue-500/10 rounded-2xl border border-cyan-500/30">
          <h3 class="text-sm font-semibold text-cyan-400 uppercase tracking-wider mb-2">üí∞ Manheim MMR Pricing</h3>
          <p class="text-slate-400 text-xs mb-4">Enter the <strong>Adjusted MMR</strong> from mmr.manheim.com (includes condition, mileage, region adjustments)</p>
          <div class="grid grid-cols-2 gap-4">
            <div><label class="text-slate-300 text-sm font-medium">Adjusted MMR (Wholesale) *</label><div class="relative mt-1"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span><input type="number" id="a_adjustedMMR" placeholder="18500" required class="w-full bg-slate-900/50 border-2 border-cyan-500/50 rounded-xl pl-8 pr-4 py-3 text-white text-lg font-bold focus:border-cyan-400 focus:outline-none"></div><p class="text-xs text-slate-500 mt-1">From Manheim - already adjusted for this vehicle</p></div>
            <div><label class="text-slate-300 text-sm font-medium">Auction Asking Price</label><div class="relative mt-1"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span><input type="number" id="a_askingPrice" placeholder="17000" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl pl-8 pr-4 py-3 text-white focus:border-cyan-500 focus:outline-none"></div><p class="text-xs text-slate-500 mt-1">Current bid or Buy Now price</p></div>
          </div>
        </div>
        <div class="mb-6 p-5 bg-amber-500/5 rounded-2xl border border-amber-500/20">
          <h3 class="text-sm font-semibold text-amber-400 uppercase tracking-wider mb-4">üìã Your Estimated Costs</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div><label class="text-slate-400 text-sm">Recon</label><input type="number" id="a_reconCost" value="500" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Transport</label><input type="number" id="a_transportCost" value="300" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Auction Fees</label><input type="number" id="a_auctionFees" value="400" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Target Profit</label><input type="number" id="a_targetProfit" value="2000" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
            <div><label class="text-slate-400 text-sm">Floor Plan/day</label><input type="number" id="a_floorPlanRate" value="35" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none"></div>
          </div>
        </div>
        <div class="mb-6"><label class="text-slate-400 text-sm">Notes</label><textarea id="a_notes" rows="2" placeholder="Any notes..." class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1 focus:border-cyan-500 focus:outline-none resize-none"></textarea></div>
        <button type="submit" class="w-full px-6 py-4 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl text-white font-bold text-lg hover:from-cyan-400 hover:to-blue-500 transition-all flex items-center justify-center gap-2">üìä Run Comprehensive Analysis</button>
      </form>
      <div id="analysisResults" class="hidden mt-8 pt-8 border-t border-slate-700"></div>
    </div>
  </div>

  <div id="statusModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
    <div class="glass border border-slate-700 rounded-3xl p-6 max-w-md w-full">
      <h3 class="text-xl font-bold text-white mb-4">Update Vehicle Status</h3>
      <input type="hidden" id="statusVehicleId">
      <div class="space-y-3 mb-6">
        <button onclick="updateStatus('watchlist')" class="w-full p-4 rounded-xl border border-slate-600 hover:border-cyan-500 hover:bg-cyan-500/10 transition-all text-left flex items-center gap-3"><span class="text-2xl">üëÅÔ∏è</span><div><p class="font-medium text-white">Watchlist</p><p class="text-sm text-slate-400">Still evaluating</p></div></button>
        <button onclick="updateStatus('inventory')" class="w-full p-4 rounded-xl border border-slate-600 hover:border-emerald-500 hover:bg-emerald-500/10 transition-all text-left flex items-center gap-3"><span class="text-2xl">‚úÖ</span><div><p class="font-medium text-white">Bought ‚Üí Inventory</p><p class="text-sm text-slate-400">I purchased this vehicle</p></div></button>
        <button onclick="updateStatus('sold')" class="w-full p-4 rounded-xl border border-slate-600 hover:border-emerald-500 hover:bg-emerald-500/10 transition-all text-left flex items-center gap-3"><span class="text-2xl">üí∞</span><div><p class="font-medium text-white">Sold</p><p class="text-sm text-slate-400">Vehicle has been sold</p></div></button>
        <button onclick="updateStatus('passed')" class="w-full p-4 rounded-xl border border-slate-600 hover:border-slate-500 hover:bg-slate-500/10 transition-all text-left flex items-center gap-3"><span class="text-2xl">‚è≠Ô∏è</span><div><p class="font-medium text-white">Passed</p><p class="text-sm text-slate-400">Decided not to buy</p></div></button>
        <button onclick="updateStatus('lost')" class="w-full p-4 rounded-xl border border-slate-600 hover:border-red-500 hover:bg-red-500/10 transition-all text-left flex items-center gap-3"><span class="text-2xl">‚ùå</span><div><p class="font-medium text-white">Lost Auction</p><p class="text-sm text-slate-400">Someone else won</p></div></button>
      </div>
      <div id="soldPriceInput" class="hidden mb-4"><label class="text-slate-400 text-sm">Actual Sale Price</label><input type="number" id="actualSalePrice" placeholder="Enter sale price" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div>
      <div id="boughtPriceInput" class="hidden mb-4"><label class="text-slate-400 text-sm">Actual Purchase Price</label><input type="number" id="actualBuyPrice" placeholder="Enter purchase price" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div>
      <button onclick="hideStatusModal()" class="w-full px-4 py-3 border border-slate-600 rounded-xl text-slate-300 hover:bg-slate-700 transition-colors">Cancel</button>
    </div>
  </div>

  <script>
    const MARKET_DATA = {
      muvviIndex: 206.0, muvviChange: 0.6, wholesaleDaysSupply: 31.7, retailDaysSupply: 46, avgDaysToSell: 40, avgUsedRetailPrice: 25730, avg3YearOldPrice: 30522, avgNewCarPrice: 49814, totalSales2025: 16300000, yoyGrowth: 2.3, avgDealerGrossProfit: 1528, avgDealerGrossMargin: 0.054,
      pricingSources: { kbb: { name: 'Kelley Blue Book', adjustment: 1.00, weight: 0.25 }, edmunds: { name: 'Edmunds TMV', adjustment: 0.98, weight: 0.20 }, cargurus: { name: 'CarGurus IMV', adjustment: 1.02, weight: 0.20 }, nada: { name: 'NADA Guides', adjustment: 1.03, weight: 0.15 }, carfax: { name: 'Carfax', adjustment: 0.99, weight: 0.10 }, blackbook: { name: 'Black Book', adjustment: 0.97, weight: 0.10 } },
      segments: { luxury: { trend: 'up', yoyChange: 2.5, avgDaysToSell: 28, demandScore: 88, avgMarkup: 0.18 }, ev: { trend: 'up', yoyChange: 2.5, avgDaysToSell: 34, demandScore: 75, avgMarkup: 0.12 }, hybrid: { trend: 'up', yoyChange: 3.2, avgDaysToSell: 30, demandScore: 90, avgMarkup: 0.16 }, crossover: { trend: 'up', yoyChange: 0.5, avgDaysToSell: 30, demandScore: 82, avgMarkup: 0.15 }, suv: { trend: 'stable', yoyChange: 0.3, avgDaysToSell: 32, demandScore: 78, avgMarkup: 0.15 }, minivan: { trend: 'up', yoyChange: 1.5, avgDaysToSell: 20, demandScore: 85, avgMarkup: 0.14 }, midsize_car: { trend: 'down', yoyChange: -1.2, avgDaysToSell: 42, demandScore: 55, avgMarkup: 0.13 }, compact_car: { trend: 'down', yoyChange: -1.8, avgDaysToSell: 45, demandScore: 50, avgMarkup: 0.12 }, pickup: { trend: 'down', yoyChange: -1.5, avgDaysToSell: 38, demandScore: 62, avgMarkup: 0.14 }, sports: { trend: 'stable', yoyChange: 0.2, avgDaysToSell: 40, demandScore: 65, avgMarkup: 0.17 } },
      makeAdjustments: { 'toyota': { reliability: 1.08, demand: 1.10, daysToSell: 0.85 }, 'honda': { reliability: 1.06, demand: 1.08, daysToSell: 0.88 }, 'lexus': { reliability: 1.10, demand: 1.12, daysToSell: 0.80 }, 'subaru': { reliability: 1.04, demand: 1.05, daysToSell: 0.90 }, 'mazda': { reliability: 1.03, demand: 1.02, daysToSell: 0.95 }, 'hyundai': { reliability: 1.00, demand: 1.02, daysToSell: 0.95 }, 'kia': { reliability: 1.00, demand: 1.03, daysToSell: 0.95 }, 'ford': { reliability: 0.98, demand: 1.00, daysToSell: 1.00 }, 'chevrolet': { reliability: 0.97, demand: 0.98, daysToSell: 1.02 }, 'gmc': { reliability: 0.98, demand: 1.00, daysToSell: 1.00 }, 'ram': { reliability: 0.96, demand: 0.95, daysToSell: 1.10 }, 'jeep': { reliability: 0.94, demand: 1.02, daysToSell: 1.00 }, 'dodge': { reliability: 0.93, demand: 0.92, daysToSell: 1.08 }, 'nissan': { reliability: 0.95, demand: 0.90, daysToSell: 1.12 }, 'volkswagen': { reliability: 0.92, demand: 0.88, daysToSell: 1.20 }, 'bmw': { reliability: 0.90, demand: 1.05, daysToSell: 1.05 }, 'mercedes-benz': { reliability: 0.88, demand: 1.08, daysToSell: 1.02 }, 'audi': { reliability: 0.89, demand: 1.04, daysToSell: 1.08 }, 'tesla': { reliability: 0.95, demand: 1.15, daysToSell: 0.85 }, 'acura': { reliability: 1.05, demand: 1.00, daysToSell: 0.95 }, 'infiniti': { reliability: 0.92, demand: 0.85, daysToSell: 1.15 }, 'cadillac': { reliability: 0.91, demand: 0.95, daysToSell: 1.10 }, 'lincoln': { reliability: 0.90, demand: 0.88, daysToSell: 1.15 }, 'buick': { reliability: 0.93, demand: 0.85, daysToSell: 1.18 }, 'genesis': { reliability: 1.02, demand: 0.95, daysToSell: 1.05 }, 'volvo': { reliability: 0.94, demand: 0.95, daysToSell: 1.05 }, 'porsche': { reliability: 0.96, demand: 1.20, daysToSell: 0.90 }, 'land rover': { reliability: 0.80, demand: 1.00, daysToSell: 1.15 }, 'jaguar': { reliability: 0.78, demand: 0.82, daysToSell: 1.30 }, 'rivian': { reliability: 0.98, demand: 1.10, daysToSell: 0.95 } },
      colorAdjustments: { 'white': { value: 1.02, daysToSell: 0.92 }, 'black': { value: 1.03, daysToSell: 0.93 }, 'silver': { value: 1.01, daysToSell: 0.95 }, 'blue': { value: 1.00, daysToSell: 1.00 }, 'red': { value: 0.99, daysToSell: 1.02 }, 'other': { value: 0.97, daysToSell: 1.08 } },
      gradeAdjustments: { 5.0: 1.15, 4.5: 1.10, 4.0: 1.05, 3.5: 1.00, 3.0: 0.95, 2.5: 0.88, 2.0: 0.80, 1.5: 0.70, 1.0: 0.60 },
      mileageAdjustmentPer10k: -0.025,
      fastestSelling: [ { rank: 1, name: 'Toyota Sienna', daysToSell: 20 }, { rank: 2, name: 'Toyota Highlander', daysToSell: 21 }, { rank: 3, name: 'Toyota Camry', daysToSell: 22 }, { rank: 4, name: 'Toyota RAV4', daysToSell: 24 }, { rank: 5, name: 'Lexus NX', daysToSell: 25 }, { rank: 6, name: 'Lexus RX', daysToSell: 26 }, { rank: 7, name: 'Honda CR-V', daysToSell: 26 }, { rank: 8, name: 'Toyota Corolla', daysToSell: 28 }, { rank: 9, name: 'Cadillac Escalade', daysToSell: 28 }, { rank: 10, name: 'Mercedes G-Class', daysToSell: 29 } ],
      usBestSellers: [ { rank: 1, name: 'Ford F-Series', sales: 828832, change: 8.3, daysToSell: 35 }, { rank: 2, name: 'Chevrolet Silverado', sales: 558709, change: 3.1, daysToSell: 38 }, { rank: 3, name: 'Toyota RAV4', sales: 480000, change: 1.5, daysToSell: 24 }, { rank: 4, name: 'Honda CR-V', sales: 420000, change: 1.4, daysToSell: 26 }, { rank: 5, name: 'Chevrolet Equinox', sales: 332301, change: 40.5, daysToSell: 28 }, { rank: 6, name: 'Toyota Camry', sales: 316185, change: 2.0, daysToSell: 22 }, { rank: 7, name: 'Tesla Model Y', sales: 300000, change: -22.0, daysToSell: 32 }, { rank: 8, name: 'Ram Pickup', sales: 295000, change: -5.4, daysToSell: 42 }, { rank: 9, name: 'GMC Sierra', sales: 280000, change: 8.0, daysToSell: 36 }, { rank: 10, name: 'Toyota Tacoma', sales: 275000, change: 42.0, daysToSell: 25 } ],
      pnwBestSellers: [ { rank: 1, name: 'Tesla Model Y', share: 8.5, note: 'Top in King County' }, { rank: 2, name: 'Toyota RAV4', share: 7.2, note: 'State favorite SUV' }, { rank: 3, name: 'Honda CR-V', share: 5.8, note: 'Strong Seattle demand' }, { rank: 4, name: 'Subaru Outback', share: 5.5, note: 'PNW icon' }, { rank: 5, name: 'Subaru Forester', share: 5.2, note: 'Seattle #1 historically' }, { rank: 6, name: 'Ford F-150', share: 4.8, note: 'Eastern WA favorite' }, { rank: 7, name: 'Toyota Tacoma', share: 4.5, note: 'Outdoor lifestyle' }, { rank: 8, name: 'Tesla Model 3', share: 4.2, note: '25% EV share King Co' }, { rank: 9, name: 'Toyota Camry', share: 3.8, note: 'Hybrid popular' }, { rank: 10, name: 'Honda Civic', share: 3.5, note: 'Urban commuter' } ],
      pnwStats: { evShare: 16.4, hybridShare: 18.5, topBrand: 'Toyota', topBrandShare: 18.5, topCountyEvShare: 25 }
    };

    let vehicles = [];
    let settings = { defaultReconCost: 500, defaultTransportCost: 300, defaultAuctionFees: 400, defaultTargetProfit: 2000, defaultFloorPlanRate: 35 };
    let currentTab = 'dashboard';
    let lastAnalysis = null;

    function calculateComprehensiveRetailValue(vehicle) {
      const mmr = vehicle.adjustedMMR || vehicle.mmrPrice;
      if (!mmr) return null;
      const year = vehicle.year, make = (vehicle.make || '').toLowerCase(), model = (vehicle.model || '').toLowerCase();
      const mileage = vehicle.mileage || 50000, grade = vehicle.grade || 3.5, color = vehicle.color || 'white', segment = vehicle.segment || 'suv';
      const age = new Date().getFullYear() - year;
      const segmentData = MARKET_DATA.segments[segment] || MARKET_DATA.segments.suv;
      const makeData = MARKET_DATA.makeAdjustments[make] || { reliability: 1.0, demand: 1.0, daysToSell: 1.0 };
      const colorData = MARKET_DATA.colorAdjustments[color] || { value: 1.0, daysToSell: 1.0 };
      let gradeMultiplier = 1.0;
      for (const [g, mult] of Object.entries(MARKET_DATA.gradeAdjustments)) { if (grade >= parseFloat(g) - 0.25 && grade < parseFloat(g) + 0.25) { gradeMultiplier = mult; break; } }
      const expectedMileage = age * 12000;
      const mileageDiff = mileage - expectedMileage;
      const mileageAdjustment = 1 + (mileageDiff / 10000) * MARKET_DATA.mileageAdjustmentPer10k;
      const isHotSeller = MARKET_DATA.fastestSelling.some(f => f.name.toLowerCase().includes(make) || f.name.toLowerCase().includes(model));
      const hotSellerBonus = isHotSeller ? 1.03 : 1.0;
      const isPnwFavorite = MARKET_DATA.pnwBestSellers.some(p => p.name.toLowerCase().includes(make) || p.name.toLowerCase().includes(model));
      const pnwBonus = isPnwFavorite ? 1.02 : 1.0;
      const baseMarkup = segmentData.avgMarkup;
      const baseRetail = mmr * (1 + baseMarkup);
      const sourceEstimates = {};
      let weightedTotal = 0, totalWeight = 0;
      for (const [key, source] of Object.entries(MARKET_DATA.pricingSources)) {
        const estimate = baseRetail * source.adjustment * makeData.demand * colorData.value * gradeMultiplier * mileageAdjustment * hotSellerBonus;
        sourceEstimates[key] = { name: source.name, estimate: Math.round(estimate), weight: source.weight };
        weightedTotal += estimate * source.weight;
        totalWeight += source.weight;
      }
      const weightedAvgRetail = weightedTotal / totalWeight;
      const estimates = Object.values(sourceEstimates).map(s => s.estimate);
      const pnwRetail = weightedAvgRetail * pnwBonus;
      let baseDays = segmentData.avgDaysToSell;
      const fastSeller = MARKET_DATA.fastestSelling.find(f => f.name.toLowerCase().includes(make) || f.name.toLowerCase().includes(model));
      if (fastSeller) baseDays = fastSeller.daysToSell;
      let daysToSell = baseDays * makeData.daysToSell * colorData.daysToSell;
      if (age > 7) daysToSell += 10; if (mileage > 100000) daysToSell += 8; if (grade < 3) daysToSell += 5;
      daysToSell = Math.max(14, Math.round(daysToSell));
      let score = 50;
      score += segmentData.demandScore * 0.3;
      if (segmentData.trend === 'up') score += 12; if (segmentData.trend === 'down') score -= 12;
      if (isHotSeller) score += 15; if (isPnwFavorite) score += 8;
      if (mileage < 30000) score += 15; else if (mileage < 60000) score += 10; else if (mileage < 100000) score += 5; else score -= 10;
      if (age <= 3) score += 15; else if (age <= 5) score += 10; else if (age <= 7) score += 5; else score -= 5;
      if (vehicle.askingPrice && mmr > vehicle.askingPrice) { const diff = ((mmr - vehicle.askingPrice) / mmr) * 100; if (diff > 10) score += 15; else if (diff > 5) score += 10; else if (diff > 0) score += 5; }
      if (grade >= 4) score += 10; else if (grade >= 3) score += 5; else if (grade < 2.5) score -= 10;
      score = Math.min(100, Math.max(0, Math.round(score)));
      return {
        recommendedRetail: Math.round(pnwRetail), nationalAvgRetail: Math.round(weightedAvgRetail),
        retailRange: { low: Math.round(Math.min(...estimates) * 0.97), high: Math.round(Math.max(...estimates) * 1.03) },
        sourceEstimates,
        adjustments: { baseMarkup: { label: 'Segment Markup (' + segment + ')', value: baseMarkup, impact: Math.round(mmr * baseMarkup) }, make: { label: vehicle.make + ' Brand Premium', value: makeData.demand, impact: Math.round(baseRetail * (makeData.demand - 1)) }, condition: { label: 'Grade ' + grade + ' Condition', value: gradeMultiplier, impact: Math.round(baseRetail * (gradeMultiplier - 1)) }, mileage: { label: 'Mileage (' + mileage.toLocaleString() + ' mi)', value: mileageAdjustment, impact: Math.round(baseRetail * (mileageAdjustment - 1)) }, color: { label: color.charAt(0).toUpperCase() + color.slice(1) + ' Color', value: colorData.value, impact: Math.round(baseRetail * (colorData.value - 1)) }, hotSeller: { label: 'Hot Seller Bonus', value: hotSellerBonus, impact: isHotSeller ? Math.round(baseRetail * 0.03) : 0 }, pnw: { label: 'PNW Regional Demand', value: pnwBonus, impact: isPnwFavorite ? Math.round(weightedAvgRetail * 0.02) : 0 } },
        marketIntel: { segment: segmentData, make: makeData, daysToSell, quickFlipScore: score, isHotSeller, isPnwFavorite, trend: segmentData.trend, demandScore: segmentData.demandScore },
        profitAnalysis: { mmr, recommendedRetail: Math.round(pnwRetail), grossProfit: Math.round(pnwRetail - mmr), grossMargin: ((pnwRetail - mmr) / pnwRetail * 100).toFixed(1) }
      };
    }

    function runAnalysis(e) {
      e.preventDefault();
      const vehicle = { id: document.getElementById('a_vehicleId').value || Date.now(), year: parseInt(document.getElementById('a_year').value), make: document.getElementById('a_make').value, model: document.getElementById('a_model').value, trim: document.getElementById('a_trim').value, vin: document.getElementById('a_vin').value.toUpperCase(), mileage: parseInt(document.getElementById('a_mileage').value) || 50000, segment: document.getElementById('a_segment').value, grade: parseFloat(document.getElementById('a_grade').value) || 3.5, color: document.getElementById('a_color').value, location: document.getElementById('a_location').value, adjustedMMR: parseInt(document.getElementById('a_adjustedMMR').value) || 0, mmrPrice: parseInt(document.getElementById('a_adjustedMMR').value) || 0, askingPrice: parseInt(document.getElementById('a_askingPrice').value) || null, reconCost: parseInt(document.getElementById('a_reconCost').value) || settings.defaultReconCost, transportCost: parseInt(document.getElementById('a_transportCost').value) || settings.defaultTransportCost, auctionFees: parseInt(document.getElementById('a_auctionFees').value) || settings.defaultAuctionFees, targetProfit: parseInt(document.getElementById('a_targetProfit').value) || settings.defaultTargetProfit, floorPlanRate: parseInt(document.getElementById('a_floorPlanRate').value) || settings.defaultFloorPlanRate, notes: document.getElementById('a_notes').value };
      const analysis = calculateComprehensiveRetailValue(vehicle);
      if (!analysis) { alert('Please enter the Adjusted MMR from Manheim'); return; }
      const totalCosts = vehicle.reconCost + vehicle.transportCost + vehicle.auctionFees;
      const maxBuy = analysis.recommendedRetail - vehicle.targetProfit - totalCosts;
      const estProfit = vehicle.askingPrice ? analysis.recommendedRetail - vehicle.askingPrice - totalCosts : null;
      const roi = estProfit && vehicle.askingPrice ? ((estProfit / (vehicle.askingPrice + totalCosts)) * 100).toFixed(1) : null;
      const floorPlanCost = analysis.marketIntel.daysToSell * vehicle.floorPlanRate;
      const netProfit = estProfit ? estProfit - floorPlanCost : null;
      const withinBudget = vehicle.askingPrice ? maxBuy >= vehicle.askingPrice : null;
      lastAnalysis = { vehicle, analysis, maxBuy, estProfit, roi, floorPlanCost, netProfit, withinBudget, totalCosts };
      renderAnalysisResults(lastAnalysis);
    }

    function renderAnalysisResults(data) {
      const { vehicle, analysis, maxBuy, estProfit, roi, floorPlanCost, netProfit, withinBudget, totalCosts } = data;
      const score = analysis.marketIntel.quickFlipScore;
      document.getElementById('analysisResults').classList.remove('hidden');
      let html = '<div class="animate-in">';
      html += '<div class="flex items-center justify-between mb-6"><div><h3 class="text-2xl font-bold text-white">' + vehicle.year + ' ' + vehicle.make + ' ' + vehicle.model + ' ' + (vehicle.trim || '') + '</h3><p class="text-slate-400">' + vehicle.mileage.toLocaleString() + ' miles ‚Ä¢ Grade ' + vehicle.grade + ' ‚Ä¢ ' + vehicle.color.charAt(0).toUpperCase() + vehicle.color.slice(1) + '</p></div><div class="flex items-center gap-2">' + (analysis.marketIntel.isHotSeller ? '<span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-sm font-medium">üî• Hot Seller</span>' : '') + (analysis.marketIntel.isPnwFavorite ? '<span class="px-3 py-1 bg-cyan-500/20 text-cyan-400 rounded-full text-sm font-medium">üå≤ PNW Favorite</span>' : '') + '</div></div>';
      html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 border border-emerald-500/30 rounded-2xl p-4 text-center"><p class="text-emerald-400 text-xs uppercase tracking-wider font-medium">Recommended Retail</p><p class="text-3xl font-black text-white mt-1">$' + analysis.recommendedRetail.toLocaleString() + '</p><p class="text-emerald-400 text-xs mt-1">PNW Market</p></div><div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center"><p class="text-slate-400 text-xs uppercase tracking-wider font-medium">Quick Flip Score</p><p class="text-3xl font-black ' + (score >= 75 ? 'text-emerald-400' : score >= 50 ? 'text-amber-400' : 'text-red-400') + ' mt-1">' + score + '</p><p class="text-slate-500 text-xs mt-1">' + (score >= 75 ? 'üî• Excellent' : score >= 50 ? '‚ö° Good' : '‚ö†Ô∏è Risky') + '</p></div><div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center"><p class="text-slate-400 text-xs uppercase tracking-wider font-medium">Days to Sell</p><p class="text-3xl font-black text-cyan-400 mt-1">' + analysis.marketIntel.daysToSell + '</p><p class="text-slate-500 text-xs mt-1">Estimated</p></div><div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 text-center"><p class="text-slate-400 text-xs uppercase tracking-wider font-medium">Max Buy Price</p><p class="text-3xl font-black text-amber-400 mt-1">$' + maxBuy.toLocaleString() + '</p><p class="text-slate-500 text-xs mt-1">For $' + vehicle.targetProfit.toLocaleString() + ' profit</p></div></div>';
      if (vehicle.askingPrice) { html += '<div class="mb-6 p-5 rounded-2xl ' + (withinBudget ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-amber-500/10 border border-amber-500/30') + '"><div class="flex items-center gap-2 mb-4"><span class="text-2xl">' + (withinBudget ? '‚úÖ' : '‚ö†Ô∏è') + '</span><h4 class="text-lg font-bold ' + (withinBudget ? 'text-emerald-400' : 'text-amber-400') + '">' + (withinBudget ? 'Good Deal - Within Budget' : 'Above Max Buy - Negotiate Lower') + '</h4></div><div class="grid grid-cols-2 md:grid-cols-5 gap-4"><div class="text-center"><p class="text-slate-400 text-xs">Asking Price</p><p class="text-xl font-bold text-white">$' + vehicle.askingPrice.toLocaleString() + '</p></div><div class="text-center"><p class="text-slate-400 text-xs">Est. Gross Profit</p><p class="text-xl font-bold ' + (estProfit >= 0 ? 'text-emerald-400' : 'text-red-400') + '">$' + estProfit.toLocaleString() + '</p></div><div class="text-center"><p class="text-slate-400 text-xs">Floor Plan Cost</p><p class="text-xl font-bold text-red-400">-$' + floorPlanCost.toLocaleString() + '</p></div><div class="text-center"><p class="text-slate-400 text-xs">Net Profit</p><p class="text-xl font-bold ' + (netProfit >= 0 ? 'text-emerald-400' : 'text-red-400') + '">$' + netProfit.toLocaleString() + '</p></div><div class="text-center"><p class="text-slate-400 text-xs">ROI</p><p class="text-xl font-bold ' + (roi >= 10 ? 'text-emerald-400' : 'text-amber-400') + '">' + roi + '%</p></div></div></div>'; }
      html += '<div class="mb-6"><h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span>üìä</span> Multi-Source Retail Value Estimates <span class="text-xs text-slate-500 font-normal">(National US Data)</span></h4><div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
      for (const [key, source] of Object.entries(analysis.sourceEstimates)) { html += '<div class="bg-slate-900/50 border border-slate-700/50 rounded-xl p-4"><div class="flex items-center justify-between mb-2"><span class="source-pill bg-slate-700 text-slate-300">' + source.name + '</span><span class="text-xs text-slate-500">' + (source.weight * 100).toFixed(0) + '% weight</span></div><p class="text-xl font-bold text-white">$' + source.estimate.toLocaleString() + '</p></div>'; }
      html += '</div><div class="mt-4 p-4 bg-slate-800/30 rounded-xl border border-slate-700/50"><div class="flex items-center justify-between"><div><p class="text-slate-400 text-sm">Retail Value Range</p><p class="text-lg font-bold text-white">$' + analysis.retailRange.low.toLocaleString() + ' ‚Äî $' + analysis.retailRange.high.toLocaleString() + '</p></div><div class="text-right"><p class="text-slate-400 text-sm">Weighted National Average</p><p class="text-lg font-bold text-cyan-400">$' + analysis.nationalAvgRetail.toLocaleString() + '</p></div></div></div></div>';
      html += '<div class="mb-6"><h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span>üîß</span> Value Adjustment Factors</h4><div class="space-y-2"><div class="flex items-center justify-between p-3 bg-cyan-500/10 rounded-xl border border-cyan-500/20"><span class="text-cyan-400 font-medium">Base Wholesale (Adjusted MMR)</span><span class="text-white font-bold">$' + vehicle.adjustedMMR.toLocaleString() + '</span></div>';
      for (const [key, adj] of Object.entries(analysis.adjustments)) { if (adj.impact !== 0) { html += '<div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-xl"><span class="text-slate-300">' + adj.label + '</span><span class="' + (adj.impact >= 0 ? 'text-emerald-400' : 'text-red-400') + ' font-medium">' + (adj.impact >= 0 ? '+' : '') + '$' + adj.impact.toLocaleString() + '</span></div>'; } }
      html += '<div class="flex items-center justify-between p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20"><span class="text-emerald-400 font-medium">= Recommended Retail</span><span class="text-white font-bold text-xl">$' + analysis.recommendedRetail.toLocaleString() + '</span></div></div></div>';
      html += '<div class="mb-6"><h4 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><span>üìà</span> Market Intelligence</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3"><div class="bg-slate-800/50 rounded-xl p-4 text-center"><p class="text-slate-400 text-xs uppercase">Segment Trend</p><p class="text-lg font-bold ' + (analysis.marketIntel.trend === 'up' ? 'text-emerald-400' : analysis.marketIntel.trend === 'down' ? 'text-red-400' : 'text-slate-300') + ' mt-1">' + (analysis.marketIntel.trend === 'up' ? '‚ñ≤ Rising' : analysis.marketIntel.trend === 'down' ? '‚ñº Falling' : '‚óè Stable') + '</p></div><div class="bg-slate-800/50 rounded-xl p-4 text-center"><p class="text-slate-400 text-xs uppercase">Segment YoY</p><p class="text-lg font-bold ' + (analysis.marketIntel.segment.yoyChange >= 0 ? 'text-emerald-400' : 'text-red-400') + ' mt-1">' + (analysis.marketIntel.segment.yoyChange >= 0 ? '+' : '') + analysis.marketIntel.segment.yoyChange + '%</p></div><div class="bg-slate-800/50 rounded-xl p-4 text-center"><p class="text-slate-400 text-xs uppercase">Demand Score</p><p class="text-lg font-bold text-white mt-1">' + analysis.marketIntel.demandScore + '/100</p></div><div class="bg-slate-800/50 rounded-xl p-4 text-center"><p class="text-slate-400 text-xs uppercase">Gross Margin</p><p class="text-lg font-bold text-white mt-1">' + analysis.profitAnalysis.grossMargin + '%</p></div></div></div>';
      html += '<div class="mb-6 p-5 bg-slate-800/30 rounded-2xl border border-slate-700/50"><h4 class="text-lg font-bold text-white mb-4">üíµ Your Cost Breakdown</h4><div class="grid grid-cols-2 md:grid-cols-6 gap-3 text-center"><div><p class="text-slate-400 text-xs">Recon</p><p class="text-white font-bold">$' + vehicle.reconCost.toLocaleString() + '</p></div><div><p class="text-slate-400 text-xs">Transport</p><p class="text-white font-bold">$' + vehicle.transportCost.toLocaleString() + '</p></div><div><p class="text-slate-400 text-xs">Auction Fees</p><p class="text-white font-bold">$' + vehicle.auctionFees.toLocaleString() + '</p></div><div><p class="text-slate-400 text-xs">Total Costs</p><p class="text-amber-400 font-bold">$' + totalCosts.toLocaleString() + '</p></div><div><p class="text-slate-400 text-xs">Floor Plan/day</p><p class="text-white font-bold">$' + vehicle.floorPlanRate + '</p></div><div><p class="text-slate-400 text-xs">Est Floor Cost</p><p class="text-red-400 font-bold">$' + floorPlanCost.toLocaleString() + '</p></div></div></div>';
      html += '<div class="mb-6 p-4 bg-slate-900/30 rounded-xl border border-slate-700/50"><p class="text-slate-500 text-xs"><strong>Data Sources:</strong> Kelley Blue Book (KBB), Edmunds TMV, CarGurus IMV, NADA Guides, Carfax, Black Book, Manheim MMR, Cox Automotive MUVVI Index. Retail estimates are weighted averages from 6 major US pricing sources with regional adjustments for the Pacific Northwest market. Last updated: January 2026.</p></div>';
      html += '<div class="flex gap-4"><button onclick="saveAnalyzedVehicle()" class="flex-1 px-6 py-4 bg-gradient-to-r from-emerald-500 to-green-600 rounded-xl text-white font-bold hover:from-emerald-400 hover:to-green-500 transition-all flex items-center justify-center gap-2">‚úÖ Save to Watchlist</button><button onclick="resetAnalysis()" class="px-6 py-4 border border-slate-600 rounded-xl text-slate-300 hover:bg-slate-700 transition-colors font-medium">Analyze Another</button></div></div>';
      document.getElementById('analysisResults').innerHTML = html;
    }

    function saveAnalyzedVehicle() { if (!lastAnalysis) return; const v = lastAnalysis.vehicle; v.retailPrice = lastAnalysis.analysis.recommendedRetail; v.status = 'watchlist'; v.bookmarked = false; v.createdAt = new Date().toISOString(); v.updatedAt = new Date().toISOString(); const existingIdx = vehicles.findIndex(x => x.id == v.id); if (existingIdx !== -1) { vehicles[existingIdx] = { ...vehicles[existingIdx], ...v }; } else { v.id = Date.now(); vehicles.push(v); } saveData(); hideAnalyzeModal(); switchTab('watchlist'); }
    function resetAnalysis() { document.getElementById('analysisResults').classList.add('hidden'); document.getElementById('analyzeForm').reset(); document.getElementById('a_year').value = new Date().getFullYear() - 3; document.getElementById('a_mileage').value = 50000; document.getElementById('a_grade').value = 3.5; document.getElementById('a_reconCost').value = settings.defaultReconCost; document.getElementById('a_transportCost').value = settings.defaultTransportCost; document.getElementById('a_auctionFees').value = settings.defaultAuctionFees; document.getElementById('a_targetProfit').value = settings.defaultTargetProfit; document.getElementById('a_floorPlanRate').value = settings.defaultFloorPlanRate; lastAnalysis = null; }
    function showAnalyzeForm() { resetAnalysis(); document.getElementById('analyzeModal').classList.remove('hidden'); }
    function hideAnalyzeModal() { document.getElementById('analyzeModal').classList.add('hidden'); }
    function getScoreColor(score) { return score >= 75 ? 'text-emerald-400' : score >= 50 ? 'text-amber-400' : 'text-red-400'; }
    function getScoreBg(score) { return score >= 75 ? 'bg-emerald-500/20 border-emerald-500/30' : score >= 50 ? 'bg-amber-500/20 border-amber-500/30' : 'bg-red-500/20 border-red-500/30'; }
    function getScoreEmoji(score) { return score >= 75 ? 'üî•' : score >= 50 ? '‚ö°' : '‚ö†Ô∏è'; }
    function formatDate(d) { if (!d) return '‚Äî'; return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
    function getDaysOwned(v) { if (!v.purchaseDate) return 0; return Math.floor((new Date() - new Date(v.purchaseDate)) / (1000 * 60 * 60 * 24)); }

    function switchTab(tab) { currentTab = tab; document.querySelectorAll('.tab-btn').forEach(btn => { btn.classList.remove('tab-active', 'text-white'); btn.classList.add('bg-slate-800/50', 'text-slate-400'); }); document.getElementById('tab-' + tab).classList.add('tab-active', 'text-white'); document.getElementById('tab-' + tab).classList.remove('bg-slate-800/50', 'text-slate-400'); document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden')); document.getElementById('content-' + tab).classList.remove('hidden'); renderTabContent(tab); }
    function renderTabContent(tab) { if (tab === 'dashboard') renderDashboard(); else if (tab === 'market') renderMarketIntel(); else if (tab === 'watchlist') renderVehicleList('watchlist'); else if (tab === 'inventory') renderVehicleList('inventory'); else if (tab === 'history') renderHistory(); else if (tab === 'settings') renderSettings(); }
    function loadData() { const saved = localStorage.getItem('manheim_pro_v3_vehicles'); const savedSettings = localStorage.getItem('manheim_pro_v3_settings'); if (saved) vehicles = JSON.parse(saved); if (savedSettings) settings = { ...settings, ...JSON.parse(savedSettings) }; }
    function saveData() { localStorage.setItem('manheim_pro_v3_vehicles', JSON.stringify(vehicles)); localStorage.setItem('manheim_pro_v3_settings', JSON.stringify(settings)); }
    function updateCounts() { document.getElementById('watchlistCount').textContent = vehicles.filter(v => v.status === 'watchlist').length; document.getElementById('inventoryCount').textContent = vehicles.filter(v => v.status === 'inventory').length; document.getElementById('historyCount').textContent = vehicles.filter(v => ['sold','passed','lost'].includes(v.status)).length; document.getElementById('headerVehicleCount').textContent = vehicles.length; }

    function renderDashboard() {
      const watchlist = vehicles.filter(v => v.status === 'watchlist'), inventory = vehicles.filter(v => v.status === 'inventory'), sold = vehicles.filter(v => v.status === 'sold');
      const totalProfit = sold.reduce((sum, v) => sum + ((v.actualSalePrice||v.retailPrice||0)-(v.actualBuyPrice||v.askingPrice||0)-(v.reconCost||500)-(v.transportCost||300)-(v.auctionFees||400)), 0);
      let html = '<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6"><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">Watchlist</p><p class="text-2xl font-bold text-white mt-1">' + watchlist.length + '</p></div><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">Inventory</p><p class="text-2xl font-bold text-emerald-400 mt-1">' + inventory.length + '</p></div><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">Total Sold</p><p class="text-2xl font-bold text-white mt-1">' + sold.length + '</p></div><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">Total Profit</p><p class="text-2xl font-bold ' + (totalProfit >= 0 ? 'text-emerald-400' : 'text-red-400') + ' mt-1">$' + totalProfit.toLocaleString() + '</p></div><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">MUVVI Index</p><p class="text-2xl font-bold text-white mt-1">' + MARKET_DATA.muvviIndex + '</p></div><div class="glass border border-slate-700/50 rounded-2xl p-4 card-hover"><p class="text-slate-500 text-xs uppercase tracking-wider">Avg Retail</p><p class="text-2xl font-bold text-cyan-400 mt-1">$' + MARKET_DATA.avgUsedRetailPrice.toLocaleString() + '</p></div></div>';
      html += '<div class="grid lg:grid-cols-3 gap-6 mb-6"><div class="glass border border-slate-700/50 rounded-2xl p-6"><h3 class="font-bold text-white mb-4">üî• Hot Segments</h3><div class="space-y-3">';
      Object.entries(MARKET_DATA.segments).filter(([k,v]) => v.trend === 'up').sort((a,b) => b[1].demandScore - a[1].demandScore).slice(0, 5).forEach(([key, seg]) => { html += '<div class="flex items-center justify-between p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20"><span class="text-white capitalize">' + key.replace('_', ' ') + '</span><span class="text-emerald-400 font-bold">+' + seg.yoyChange + '%</span></div>'; });
      html += '</div></div><div class="glass border border-slate-700/50 rounded-2xl p-6"><h3 class="font-bold text-white mb-4">‚ùÑÔ∏è Cold Segments</h3><div class="space-y-3">';
      Object.entries(MARKET_DATA.segments).filter(([k,v]) => v.trend === 'down').sort((a,b) => a[1].yoyChange - b[1].yoyChange).slice(0, 5).forEach(([key, seg]) => { html += '<div class="flex items-center justify-between p-3 bg-red-500/10 rounded-xl border border-red-500/20"><span class="text-white capitalize">' + key.replace('_', ' ') + '</span><span class="text-red-400 font-bold">' + seg.yoyChange + '%</span></div>'; });
      html += '</div></div><div class="glass border border-slate-700/50 rounded-2xl p-6"><h3 class="font-bold text-white mb-4">‚ö° Fastest Selling</h3><div class="space-y-2">';
      MARKET_DATA.fastestSelling.slice(0, 5).forEach(car => { html += '<div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg"><span class="text-slate-300 text-sm">' + car.name + '</span><span class="text-cyan-400 font-bold text-sm">' + car.daysToSell + 'd</span></div>'; });
      html += '</div></div></div>';
      html += '<div class="glass border border-slate-700/50 rounded-2xl p-6"><h3 class="font-bold text-white mb-4">‚ö° Recent Activity</h3>';
      if (vehicles.length > 0) {
        html += '<div class="space-y-3">';
        [...vehicles].sort((a,b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt)).slice(0, 5).forEach(v => {
          const analysis = calculateComprehensiveRetailValue(v); const score = analysis ? analysis.marketIntel.quickFlipScore : 50;
          html += '<div class="flex items-center justify-between p-3 bg-slate-900/30 rounded-xl"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center text-lg">' + getScoreEmoji(score) + '</div><div><p class="font-medium text-white">' + v.year + ' ' + v.make + ' ' + v.model + '</p><p class="text-sm text-slate-500">' + formatDate(v.updatedAt || v.createdAt) + '</p></div></div><div class="text-right"><span class="text-sm ' + (v.status === 'sold' ? 'text-emerald-400' : v.status === 'inventory' ? 'text-cyan-400' : 'text-slate-400') + '">' + v.status + '</span>' + (v.retailPrice ? '<p class="text-emerald-400 font-bold text-sm">$' + v.retailPrice.toLocaleString() + '</p>' : '') + '</div></div>';
        });
        html += '</div>';
      } else { html += '<p class="text-slate-500 text-center py-8">No activity yet. Click "Analyze Vehicle" to get started!</p>'; }
      html += '</div>';
      document.getElementById('content-dashboard').innerHTML = html;
      updateCounts();
    }

    function renderMarketIntel() {
      let html = '<div class="space-y-6"><div class="glass border border-slate-700/50 rounded-2xl p-6"><div class="flex items-center justify-between mb-6"><div><h2 class="text-2xl font-bold text-white">üìä Live Market Intelligence</h2><p class="text-slate-400 mt-1">Data from KBB, Edmunds, CarGurus, NADA, Carfax, Black Book, Manheim ‚Ä¢ Jan 2026</p></div><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500 pulse-dot"></span><span class="text-emerald-400 text-sm">Live</span></div></div><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">MUVVI Index</p><p class="text-2xl font-bold text-white">' + MARKET_DATA.muvviIndex + '</p><p class="text-emerald-400 text-sm">+' + MARKET_DATA.muvviChange + '% YoY</p></div><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">Wholesale Supply</p><p class="text-2xl font-bold text-white">' + MARKET_DATA.wholesaleDaysSupply + '</p><p class="text-slate-400 text-sm">days</p></div><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">Avg Days to Sell</p><p class="text-2xl font-bold text-cyan-400">' + MARKET_DATA.avgDaysToSell + '</p><p class="text-slate-400 text-sm">used cars</p></div><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">Avg Used Retail</p><p class="text-2xl font-bold text-white">$' + (MARKET_DATA.avgUsedRetailPrice/1000).toFixed(1) + 'K</p><p class="text-slate-400 text-sm">national</p></div><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">Dealer Gross Profit</p><p class="text-2xl font-bold text-emerald-400">$' + MARKET_DATA.avgDealerGrossProfit.toLocaleString() + '</p><p class="text-slate-400 text-sm">per vehicle</p></div><div class="bg-slate-900/50 rounded-xl p-4 text-center"><p class="text-slate-500 text-xs uppercase">2025 Total Sales</p><p class="text-2xl font-bold text-white">' + (MARKET_DATA.totalSales2025/1000000).toFixed(1) + 'M</p><p class="text-emerald-400 text-sm">+' + MARKET_DATA.yoyGrowth + '% YoY</p></div></div></div>';
      html += '<div class="grid lg:grid-cols-2 gap-6"><div class="glass border border-slate-700/50 rounded-2xl p-6"><h3 class="text-xl font-bold text-white mb-4">üá∫üá∏ US Best Sellers 2025</h3><div class="space-y-2 max-h-[400px] overflow-y-auto scrollbar-thin pr-2">';
      MARKET_DATA.usBestSellers.forEach(car => { html += '<div class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-800/50 transition-colors"><span class="rank-badge ' + (car.rank <= 3 ? 'hot-gradient text-white' : 'bg-slate-700 text-slate-300') + '">' + car.rank + '</span><div class="flex-1"><p class="text-white font-medium">' + car.name + '</p><p class="text-xs text-slate-500">' + (car.sales/1000).toFixed(0) + 'K sold ‚Ä¢ ' + car.daysToSell + 'd avg</p></div><span class="' + (car.change >= 0 ? 'text-emerald-400' : 'text-red-400') + ' font-bold">' + (car.change >= 0 ? '+' : '') + car.change + '%</span></div>'; });
      html += '</div></div><div class="glass border border-cyan-500/20 rounded-2xl p-6 bg-gradient-to-br from-cyan-500/5 to-blue-500/5"><h3 class="text-xl font-bold text-white mb-4">üå≤ Washington / PNW Best Sellers</h3><div class="space-y-2 max-h-[350px] overflow-y-auto scrollbar-thin pr-2">';
      MARKET_DATA.pnwBestSellers.forEach(car => { html += '<div class="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-800/50 transition-colors"><span class="rank-badge ' + (car.rank <= 3 ? 'cool-gradient text-white' : 'bg-slate-700 text-slate-300') + '">' + car.rank + '</span><div class="flex-1"><p class="text-white font-medium">' + car.name + '</p><p class="text-xs text-slate-500">' + car.note + '</p></div><span class="text-cyan-400 font-bold">' + car.share + '%</span></div>'; });
      html += '</div><div class="mt-4 p-3 bg-cyan-500/10 rounded-xl border border-cyan-500/20"><p class="text-cyan-400 text-sm"><strong>PNW:</strong> EV ' + MARKET_DATA.pnwStats.evShare + '% share ‚Ä¢ Hybrid ' + MARKET_DATA.pnwStats.hybridShare + '% ‚Ä¢ King County EVs ' + MARKET_DATA.pnwStats.topCountyEvShare + '%</p></div></div></div></div>';
      document.getElementById('content-market').innerHTML = html;
    }

    function renderVehicleList(statusFilter) {
      let filtered = vehicles.filter(v => v.status === statusFilter);
      const container = document.getElementById('content-' + statusFilter);
      if (filtered.length === 0) { container.innerHTML = '<div class="glass border border-slate-700/50 border-dashed rounded-2xl p-12 text-center"><div class="text-6xl mb-4">' + (statusFilter === 'inventory' ? 'üì¶' : 'üëÅÔ∏è') + '</div><h3 class="text-xl font-semibold text-slate-400 mb-2">No vehicles in ' + statusFilter + '</h3><p class="text-slate-500 mb-6">Analyze a vehicle to get started.</p><button onclick="showAnalyzeForm()" class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-semibold">üîç Analyze Vehicle</button></div>'; return; }
      const sorted = [...filtered].sort((a, b) => { const analysisA = calculateComprehensiveRetailValue(a); const analysisB = calculateComprehensiveRetailValue(b); return (analysisB?.marketIntel.quickFlipScore || 0) - (analysisA?.marketIntel.quickFlipScore || 0); });
      let html = '<div class="flex items-center justify-between mb-4"><h2 class="text-lg font-bold text-white">' + statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1) + ' (' + filtered.length + ')</h2></div><div class="grid md:grid-cols-2 xl:grid-cols-3 gap-4">';
      sorted.forEach(v => { html += renderVehicleCard(v); });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderVehicleCard(v) {
      const analysis = calculateComprehensiveRetailValue(v);
      if (!analysis) return '';
      const score = analysis.marketIntel.quickFlipScore;
      const days = v.status === 'inventory' ? getDaysOwned(v) : analysis.marketIntel.daysToSell;
      const totalCosts = (v.reconCost||500) + (v.transportCost||300) + (v.auctionFees||400);
      const maxBuy = analysis.recommendedRetail - (v.targetProfit || 2000) - totalCosts;
      const profit = v.askingPrice ? analysis.recommendedRetail - v.askingPrice - totalCosts : null;
      const roi = profit && v.askingPrice ? ((profit / (v.askingPrice + totalCosts)) * 100).toFixed(1) : null;
      const floorPlan = days * (v.floorPlanRate || 35);
      const withinBudget = v.askingPrice && maxBuy >= v.askingPrice;
      let html = '<div class="glass border border-slate-700/50 rounded-2xl p-5 card-hover ' + (analysis.marketIntel.isHotSeller ? 'ring-2 ring-emerald-500/30' : '') + '"><div class="flex justify-between items-start mb-3"><div class="flex-1"><div class="flex items-center gap-2 flex-wrap"><h3 class="text-lg font-bold text-white">' + v.year + ' ' + v.make + ' ' + v.model + '</h3>' + (v.bookmarked ? '<span class="text-amber-400">‚òÖ</span>' : '') + '</div><div class="flex items-center gap-2 mt-1 flex-wrap">' + (analysis.marketIntel.isHotSeller ? '<span class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full">üî• Hot</span>' : '') + (analysis.marketIntel.isPnwFavorite ? '<span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full">üå≤ PNW</span>' : '') + '</div><p class="text-slate-400 text-sm mt-1">' + (v.trim || 'Base') + ' ‚Ä¢ ' + (v.mileage || 0).toLocaleString() + ' mi ‚Ä¢ Grade ' + v.grade + '</p></div><div class="flex gap-1"><button onclick="toggleBookmark(' + v.id + ')" class="p-2 rounded-lg hover:bg-slate-700/50 ' + (v.bookmarked ? 'text-amber-400' : 'text-slate-500') + '">‚òÖ</button><button onclick="editVehicle(' + v.id + ')" class="p-2 rounded-lg hover:bg-slate-700/50 text-slate-500">‚úèÔ∏è</button><button onclick="confirmDelete(' + v.id + ')" class="p-2 rounded-lg hover:bg-red-500/20 text-slate-500 hover:text-red-400">üóëÔ∏è</button></div></div>';
      html += '<div class="' + getScoreBg(score) + ' border rounded-xl p-3 mb-3"><div class="flex items-center justify-between"><span class="text-slate-300 text-sm font-medium">' + getScoreEmoji(score) + ' Quick Flip Score</span><span class="text-2xl font-black ' + getScoreColor(score) + '">' + score + '</span></div></div>';
      html += '<div class="grid grid-cols-2 gap-2 mb-3 text-sm"><div class="bg-slate-900/50 rounded-lg p-2"><p class="text-slate-500 text-xs">Adj. MMR</p><p class="text-cyan-400 font-bold">' + ((v.adjustedMMR || v.mmrPrice) ? '$' + (v.adjustedMMR || v.mmrPrice).toLocaleString() : '‚Äî') + '</p></div><div class="bg-slate-900/50 rounded-lg p-2"><p class="text-slate-500 text-xs">Asking</p><p class="text-white font-bold">' + (v.askingPrice ? '$' + v.askingPrice.toLocaleString() : '‚Äî') + '</p></div><div class="bg-emerald-500/10 rounded-lg p-2 border border-emerald-500/20"><p class="text-slate-500 text-xs">Est. Retail</p><p class="text-emerald-400 font-bold">$' + analysis.recommendedRetail.toLocaleString() + '</p></div><div class="bg-slate-900/50 rounded-lg p-2"><p class="text-slate-500 text-xs">Max Buy</p><p class="text-amber-400 font-bold">$' + maxBuy.toLocaleString() + '</p></div></div>';
      html += '<div class="grid grid-cols-4 gap-2 mb-3 text-center text-xs"><div class="bg-slate-900/30 rounded-lg p-2"><p class="text-white font-bold">' + days + 'd</p><p class="text-slate-500">' + (v.status === 'inventory' ? 'Owned' : 'To Sell') + '</p></div><div class="bg-slate-900/30 rounded-lg p-2"><p class="' + (profit && profit > 0 ? 'text-emerald-400' : 'text-red-400') + ' font-bold">' + (profit ? '$' + profit.toLocaleString() : '‚Äî') + '</p><p class="text-slate-500">Profit</p></div><div class="bg-slate-900/30 rounded-lg p-2"><p class="' + (roi && roi > 0 ? 'text-emerald-400' : 'text-red-400') + ' font-bold">' + (roi ? roi + '%' : '‚Äî') + '</p><p class="text-slate-500">ROI</p></div><div class="bg-slate-900/30 rounded-lg p-2"><p class="text-red-400 font-bold">$' + floorPlan + '</p><p class="text-slate-500">Floor$</p></div></div>';
      html += '<div class="flex items-center justify-between"><div class="' + (withinBudget ? 'text-emerald-400' : withinBudget === false ? 'text-amber-400' : 'text-slate-500') + ' text-xs font-medium">' + (withinBudget ? '‚úì Good deal' : withinBudget === false ? '‚ö† Above max' : '‚Äî') + '</div><button onclick="showStatusModal(' + v.id + ')" class="px-3 py-1.5 bg-slate-700/50 hover:bg-slate-600/50 rounded-lg text-sm text-slate-300">Update Status</button></div></div>';
      return html;
    }

    function renderHistory() {
      const history = vehicles.filter(v => ['sold', 'passed', 'lost'].includes(v.status)).sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
      const container = document.getElementById('content-history');
      if (history.length === 0) { container.innerHTML = '<div class="glass border border-slate-700/50 border-dashed rounded-2xl p-12 text-center"><div class="text-6xl mb-4">üìú</div><h3 class="text-xl font-semibold text-slate-400">No history yet</h3></div>'; return; }
      const sold = history.filter(v => v.status === 'sold');
      const totalProfit = sold.reduce((sum, v) => sum + ((v.actualSalePrice||v.retailPrice||0)-(v.actualBuyPrice||v.askingPrice||0)-(v.reconCost||500)-(v.transportCost||300)-(v.auctionFees||400)), 0);
      let html = '<div class="glass border border-slate-700/50 rounded-2xl p-6 mb-6"><h3 class="text-lg font-bold text-white mb-4">üìä Performance Summary</h3><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div class="bg-slate-900/50 rounded-xl p-4"><p class="text-slate-500 text-xs uppercase">Total Sold</p><p class="text-2xl font-bold text-emerald-400">' + sold.length + '</p></div><div class="bg-slate-900/50 rounded-xl p-4"><p class="text-slate-500 text-xs uppercase">Total Profit</p><p class="text-2xl font-bold ' + (totalProfit >= 0 ? 'text-emerald-400' : 'text-red-400') + '">$' + totalProfit.toLocaleString() + '</p></div><div class="bg-slate-900/50 rounded-xl p-4"><p class="text-slate-500 text-xs uppercase">Avg Profit</p><p class="text-2xl font-bold text-white">' + (sold.length > 0 ? '$' + Math.round(totalProfit/sold.length).toLocaleString() : '‚Äî') + '</p></div><div class="bg-slate-900/50 rounded-xl p-4"><p class="text-slate-500 text-xs uppercase">Passed/Lost</p><p class="text-2xl font-bold text-slate-400">' + (history.length - sold.length) + '</p></div></div></div><div class="space-y-3">';
      history.forEach(v => { html += '<div class="glass border border-slate-700/50 rounded-xl p-4 flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl ' + (v.status === 'sold' ? 'bg-emerald-500/20' : 'bg-slate-700/50') + ' flex items-center justify-center text-xl">' + (v.status === 'sold' ? 'üí∞' : v.status === 'passed' ? '‚è≠Ô∏è' : '‚ùå') + '</div><div><p class="font-medium text-white">' + v.year + ' ' + v.make + ' ' + v.model + '</p><p class="text-sm text-slate-500">' + formatDate(v.updatedAt) + '</p></div></div><div class="text-right"><span class="text-xs px-2 py-1 rounded-full ' + (v.status === 'sold' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-500/20 text-slate-400') + '">' + v.status + '</span>' + (v.status === 'sold' ? '<p class="text-emerald-400 font-bold mt-1">+$' + ((v.actualSalePrice||v.retailPrice||0)-(v.actualBuyPrice||v.askingPrice||0)-(v.reconCost||500)-(v.transportCost||300)-(v.auctionFees||400)).toLocaleString() + '</p>' : '') + '</div></div>'; });
      html += '</div>';
      container.innerHTML = html;
    }

    function renderSettings() {
      document.getElementById('content-settings').innerHTML = '<div class="glass border border-slate-700/50 rounded-2xl p-6 max-w-2xl"><h2 class="text-xl font-bold text-white mb-6">‚öôÔ∏è Default Settings</h2><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="text-slate-400 text-sm">Recon Cost</label><input type="number" id="s_reconCost" value="' + settings.defaultReconCost + '" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div><div><label class="text-slate-400 text-sm">Transport</label><input type="number" id="s_transportCost" value="' + settings.defaultTransportCost + '" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div><div><label class="text-slate-400 text-sm">Auction Fees</label><input type="number" id="s_auctionFees" value="' + settings.defaultAuctionFees + '" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div><div><label class="text-slate-400 text-sm">Target Profit</label><input type="number" id="s_targetProfit" value="' + settings.defaultTargetProfit + '" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div><div><label class="text-slate-400 text-sm">Floor Plan $/day</label><input type="number" id="s_floorPlanRate" value="' + settings.defaultFloorPlanRate + '" class="w-full bg-slate-900/50 border border-slate-600 rounded-xl px-4 py-2.5 text-white mt-1"></div></div><button onclick="saveSettings()" class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-semibold">Save Settings</button><div class="mt-8 pt-6 border-t border-slate-700"><h3 class="text-lg font-bold text-white mb-4">Data Management</h3><div class="flex gap-3"><button onclick="exportAllData()" class="px-4 py-2 border border-slate-600 rounded-xl text-slate-300 hover:bg-slate-700">Export CSV</button><button onclick="if(confirm(\'Delete ALL data?\'))if(confirm(\'Really?\')){vehicles=[];saveData();switchTab(\'dashboard\');}" class="px-4 py-2 border border-red-500/50 rounded-xl text-red-400 hover:bg-red-500/20">Clear All</button></div></div></div>';
    }
    function saveSettings() { settings.defaultReconCost = parseInt(document.getElementById('s_reconCost').value) || 500; settings.defaultTransportCost = parseInt(document.getElementById('s_transportCost').value) || 300; settings.defaultAuctionFees = parseInt(document.getElementById('s_auctionFees').value) || 400; settings.defaultTargetProfit = parseInt(document.getElementById('s_targetProfit').value) || 2000; settings.defaultFloorPlanRate = parseInt(document.getElementById('s_floorPlanRate').value) || 35; saveData(); alert('Settings saved!'); }

    function editVehicle(id) { const v = vehicles.find(x => x.id === id); if (!v) return; document.getElementById('a_vehicleId').value = v.id; document.getElementById('a_year').value = v.year; document.getElementById('a_make').value = v.make; document.getElementById('a_model').value = v.model; document.getElementById('a_trim').value = v.trim || ''; document.getElementById('a_vin').value = v.vin || ''; document.getElementById('a_mileage').value = v.mileage || 50000; document.getElementById('a_segment').value = v.segment || 'suv'; document.getElementById('a_grade').value = v.grade || 3.5; document.getElementById('a_color').value = v.color || 'white'; document.getElementById('a_location').value = v.location || ''; document.getElementById('a_adjustedMMR').value = v.adjustedMMR || v.mmrPrice || ''; document.getElementById('a_askingPrice').value = v.askingPrice || ''; document.getElementById('a_reconCost').value = v.reconCost || settings.defaultReconCost; document.getElementById('a_transportCost').value = v.transportCost || settings.defaultTransportCost; document.getElementById('a_auctionFees').value = v.auctionFees || settings.defaultAuctionFees; document.getElementById('a_targetProfit').value = v.targetProfit || settings.defaultTargetProfit; document.getElementById('a_floorPlanRate').value = v.floorPlanRate || settings.defaultFloorPlanRate; document.getElementById('a_notes').value = v.notes || ''; document.getElementById('analysisResults').classList.add('hidden'); document.getElementById('analyzeModal').classList.remove('hidden'); }
    function toggleBookmark(id) { const v = vehicles.find(x => x.id === id); if (v) { v.bookmarked = !v.bookmarked; v.updatedAt = new Date().toISOString(); saveData(); switchTab(currentTab); } }
    function showStatusModal(id) { document.getElementById('statusVehicleId').value = id; document.getElementById('soldPriceInput').classList.add('hidden'); document.getElementById('boughtPriceInput').classList.add('hidden'); document.getElementById('statusModal').classList.remove('hidden'); }
    function hideStatusModal() { document.getElementById('statusModal').classList.add('hidden'); }
    function updateStatus(newStatus) { const id = parseInt(document.getElementById('statusVehicleId').value); const v = vehicles.find(x => x.id === id); if (!v) return; if (newStatus === 'sold') { const pi = document.getElementById('soldPriceInput'); if (pi.classList.contains('hidden')) { pi.classList.remove('hidden'); document.getElementById('actualSalePrice').value = v.retailPrice || ''; return; } v.actualSalePrice = parseInt(document.getElementById('actualSalePrice').value) || v.retailPrice; } if (newStatus === 'inventory') { const pi = document.getElementById('boughtPriceInput'); if (pi.classList.contains('hidden')) { pi.classList.remove('hidden'); document.getElementById('actualBuyPrice').value = v.askingPrice || ''; return; } v.actualBuyPrice = parseInt(document.getElementById('actualBuyPrice').value) || v.askingPrice; v.purchaseDate = new Date().toISOString(); } v.status = newStatus; v.updatedAt = new Date().toISOString(); saveData(); hideStatusModal(); switchTab(currentTab); }
    function confirmDelete(id) { if (confirm('Delete this vehicle?')) { vehicles = vehicles.filter(v => v.id !== id); saveData(); switchTab(currentTab); } }

    function importCSV(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const lines = e.target.result.split('\n'); const headers = lines[0].split(',').map(h => h.trim().toLowerCase()); let imported = 0; for (let i = 1; i < lines.length; i++) { if (!lines[i].trim()) continue; const vals = lines[i].split(','); const v = { id: Date.now() + i, year: parseInt(vals[headers.indexOf('year')]) || 2022, make: vals[headers.indexOf('make')] || 'Unknown', model: vals[headers.indexOf('model')] || 'Unknown', trim: vals[headers.indexOf('trim')] || '', vin: (vals[headers.indexOf('vin')] || '').toUpperCase(), mileage: parseInt(vals[headers.indexOf('mileage')]) || 50000, segment: vals[headers.indexOf('segment')] || 'suv', grade: parseFloat(vals[headers.indexOf('grade')]) || 3.5, color: vals[headers.indexOf('color')] || 'white', adjustedMMR: parseInt(vals[headers.indexOf('mmr')]) || parseInt(vals[headers.indexOf('adjustedmmr')]) || null, mmrPrice: parseInt(vals[headers.indexOf('mmr')]) || parseInt(vals[headers.indexOf('adjustedmmr')]) || null, askingPrice: parseInt(vals[headers.indexOf('asking')]) || parseInt(vals[headers.indexOf('askingprice')]) || null, reconCost: settings.defaultReconCost, transportCost: settings.defaultTransportCost, auctionFees: settings.defaultAuctionFees, targetProfit: settings.defaultTargetProfit, floorPlanRate: settings.defaultFloorPlanRate, status: 'watchlist', bookmarked: false, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() }; const analysis = calculateComprehensiveRetailValue(v); if (analysis) v.retailPrice = analysis.recommendedRetail; vehicles.push(v); imported++; } saveData(); switchTab(currentTab); alert('Imported ' + imported + ' vehicles with retail values calculated!'); }; reader.readAsText(file); event.target.value = ''; }
    function exportAllData() { const headers = ['Year','Make','Model','Trim','VIN','Mileage','Segment','Grade','Color','AdjustedMMR','Asking','EstRetail','MaxBuy','Score','DaysToSell','ROI','Status','Bookmarked','Notes']; const rows = vehicles.map(v => { const analysis = calculateComprehensiveRetailValue(v); const totalCosts = (v.reconCost||500)+(v.transportCost||300)+(v.auctionFees||400); const maxBuy = analysis ? analysis.recommendedRetail - (v.targetProfit||2000) - totalCosts : 0; const profit = v.askingPrice && analysis ? analysis.recommendedRetail - v.askingPrice - totalCosts : null; const roi = profit && v.askingPrice ? ((profit/(v.askingPrice+totalCosts))*100).toFixed(1) : ''; return [v.year, v.make, v.model, v.trim||'', v.vin||'', v.mileage, v.segment, v.grade, v.color, v.adjustedMMR||v.mmrPrice||'', v.askingPrice||'', analysis?.recommendedRetail||'', Math.round(maxBuy), analysis?.marketIntel.quickFlipScore||'', analysis?.marketIntel.daysToSell||'', roi, v.status, v.bookmarked?'Yes':'No', (v.notes||'').replace(/,/g,';')]; }); const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'manheim-export-' + new Date().toISOString().split('T')[0] + '.csv'; a.click(); }

    document.getElementById('analyzeModal').addEventListener('click', function(e) { if (e.target === this) hideAnalyzeModal(); });
    document.getElementById('statusModal').addEventListener('click', function(e) { if (e.target === this) hideStatusModal(); });
    loadData();
    renderDashboard();
  </script>
</body>
</html>
